version: 2.1

orbs:
  heroku: circleci/heroku@1.2.6

jobs:
  build-front:
    docker:
      - image: cimg/node:20.0
    working_directory: ~/repo/front/app
    steps:
      - checkout:
          path: ~/repo
      - restore_cache:
          keys:
            - v1-front-dependencies-{{ checksum "package-lock.json" }}
            - v1-front-dependencies-
      - run:
          name: Install dependencies
          command: npm ci
      - save_cache:
          paths:
            - node_modules
          key: v1-front-dependencies-{{ checksum "package-lock.json" }}
      - run:
          name: Build application
          command: npm run build
      - persist_to_workspace:
          root: .
          paths:
            - dist
            - package.json
            - server.js

  deploy-front:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout:
          path: ~/repo
      - setup_remote_docker:
          version: 20.10.14
      - attach_workspace:
          at: ~/repo/front/app
      - heroku/install
      - run:
          name: Deploy to Heroku
          command: |
            cd ~/repo/front
            heroku container:login
            heroku container:push web -a $HEROKU_FRONT_APP_NAME
            heroku container:release web -a $HEROKU_FRONT_APP_NAME
      - run:
          name: Set Heroku config
          command: |
            heroku config:set NODE_ENV=production -a $HEROKU_FRONT_APP_NAME
            heroku config:set VITE_API_URL=$PROD_API_URL -a $HEROKU_FRONT_APP_NAME

  # API用
  # build-api:
  #   docker:
  #     - image: cimg/ruby:3.1
  #   working_directory: ~/repo/api
  #   steps:
  #     - checkout:
  #         path: ~/repo
  #     # Add steps to build and test the Rails API

  # Future job for deploying the API (uncomment when ready)
  # deploy-api:
  #   docker:
  #     - image: cimg/base:stable
  #   steps:
  #     - checkout:
  #         path: ~/repo
  #     # Add steps to deploy the Rails API to Heroku

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build-front
      - deploy-front:
          requires:
            - build-front
          filters:
            branches:
              only: main
      # API用
      # - build-api
      # - deploy-api:
      #     requires:
      #       - build-api
      #     filters:
      #       branches:
      #         only: main